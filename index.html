<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Buy / Resell NFT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 40px;
      display: flex;
      justify-content: center;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 400px;
    }
    h2 {
      margin-bottom: 20px;
      text-align: center;
    }
    input, button {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .message {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
    }
    .nft-display img {
      max-width: 100%;
      border-radius: 10px;
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }
    .tab-btn {
      background: #ddd;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 6px;
    }
    .tab-btn.active {
      background: #4CAF50;
      color: white;
    }
    .hidden { display: none; }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px;
      border-radius: 8px;
      z-index: 999;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Ultra NFT Marketplace</h2>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('buy')">ğŸ›’ Buy NFT</button>
    <button class="tab-btn" onclick="showTab('resell')">ğŸ“¤ Resell NFT</button>
  </div>

  <div id="accountInfo">ğŸ”Œ Not connected</div>
  <button onclick="loginWallet()">ğŸ” Connect Wallet</button>

  <!-- BUY TAB -->
  <div id="buyTab">
    <input type="number" id="tokenId" placeholder="Token ID" required />
    <input type="text" id="maxPrice" placeholder="Max Price (e.g. 4.00000000)" required />
    <input type="text" id="receiver" placeholder="Receiver Account" required />
    <button onclick="buyNFT()">ğŸ›’ Buy</button>
  </div>

  <!-- RESELL TAB -->
  <div id="resellTab" class="hidden">
    <input type="number" id="resellTokenId" placeholder="Token ID to Resell" required />
    <input type="text" id="resellPrice" placeholder="Resell Price (e.g. 4.00000000)" required />
    <input type="number" id="promoterShare" placeholder="Promoter Share (250-1000)" required />
    <input type="text" id="resellMemo" placeholder="Memo (optional)" />
    <button onclick="resellNFT()">ğŸ“¤ Put for Sale</button>
  </div>

  <div id="message" class="message"></div>
  <div id="nftDetails" class="nft-display"></div>
</div>

<div id="customToast" class="toast hidden"></div>
<script>
  let connectedAccount = null;

  function showTab(tab) {
    console.log("ğŸ”„ Switching tab to:", tab);
    document.getElementById('buyTab').classList.add('hidden');
    document.getElementById('resellTab').classList.add('hidden');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    if (tab === 'buy') {
      document.getElementById('buyTab').classList.remove('hidden');
      document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
    } else {
      document.getElementById('resellTab').classList.remove('hidden');
      document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
    }
  }

  function showCustomToast(id, html) {
    console.log("ğŸ”” Showing toast:", html);
    const toast = document.getElementById(id);
    toast.innerHTML = html;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 5000);
  }

  async function loginWallet() {
    console.log("ğŸ” Attempting to connect wallet...");
    try {
      const response = await ultra.connect({ referralCode: 'ecd1f052-9d0d-4b84-8dd3-10a753d044b5' });
      console.log("âœ… Wallet connected response:", response);
      connectedAccount = response.data.blockchainid;
      document.getElementById("accountInfo").innerHTML = `âœ… Connected: <strong>${connectedAccount}</strong>`;
      showCustomToast("customToast", `<strong>ğŸ” Wallet Connected</strong><br>${connectedAccount}`);
    } catch (err) {
      console.error("âŒ Wallet connection error:", err);
      showCustomToast("customToast", `<strong>âŒ Error:</strong> ${err.message || "Could not connect"}`);
    }
  }

  async function buyNFT() {
    console.log("ğŸ›’ Starting NFT purchase...");
    const tokenId = document.getElementById("tokenId").value.trim();
    const maxPriceInput = document.getElementById("maxPrice").value.trim();
    const receiver = document.getElementById("receiver").value.trim();
    const messageDiv = document.getElementById("message");
    const nftDiv = document.getElementById("nftDetails");

    console.log("ğŸ“¥ Input values:", { tokenId, maxPriceInput, receiver });

    if (!window.ultra) {
      console.warn("âŒ Ultra Extension not detected.");
      return showCustomToast("customToast", "âŒ Ultra Extension not detected.");
    }

    if (!connectedAccount) {
      console.warn("âš ï¸ Wallet not connected.");
      return showCustomToast("customToast", "âš ï¸ Please connect your wallet.");
    }

    if (!tokenId || !maxPriceInput || !receiver) {
      console.warn("âš ï¸ Missing fields.");
      return showCustomToast("customToast", "âš ï¸ All fields are required.");
    }

    const formattedPrice = `${parseFloat(maxPriceInput).toFixed(8)} UOS`;
    console.log("ğŸ’° Formatted price:", formattedPrice);

    const action = {
      account: "eosio.nft.ft",
      name: "buy",
      authorization: [{ actor: connectedAccount, permission: "active" }],
      data: {
        buy: {
          buyer: connectedAccount,
          receiver: receiver,
          token_id: parseInt(tokenId),
          memo: "Buying via Ultra",
          max_price: formattedPrice,
          promoter_id: "ultra"
        }
      }
    };

    console.log("ğŸš€ Transaction action object:", action);

    try {
      const result = await ultra.signTransaction({ actions: [action] }, { blocksBehind: 3, expireSeconds: 30 });
      console.log("âœ… Transaction submitted:", result);
      messageDiv.textContent = "âœ… Transaction submitted!";

      const metaResponse = await fetch(`https://explorer.ultra.io/api/v1/token/${tokenId}`);
      const meta = await metaResponse.json();
      console.log("ğŸ“¦ Metadata response:", meta);

      if (meta?.data) {
        nftDiv.innerHTML = `
          <h3>ğŸ‰ NFT Purchased!</h3>
          <p><strong>Name:</strong> ${meta.data.name || "Unnamed NFT"}</p>
          <img src="${meta.data.image_url || meta.data.image || ''}" alt="NFT Image" />
        `;
      } else {
        nftDiv.innerHTML = `<p>âœ… NFT bought, but no metadata found.</p>`;
      }

    } catch (error) {
      console.error("âŒ NFT Purchase error:", error);
      messageDiv.textContent = `âŒ Error: ${error.message || "Transaction failed."}`;
      nftDiv.innerHTML = "";
    }
  }

  async function resellNFT() {
    console.log("ğŸ“¤ Starting NFT resale...");
    const tokenId = document.getElementById("resellTokenId").value.trim();
    const priceInput = document.getElementById("resellPrice").value.trim();
    const promoterShare = document.getElementById("promoterShare").value.trim();
    const memo = document.getElementById("resellMemo").value.trim() || "Up for Sale!";
    const messageDiv = document.getElementById("message");

    console.log("ğŸ“¥ Resale Inputs:", { tokenId, priceInput, promoterShare, memo });

    if (!window.ultra) {
      console.warn("âŒ Ultra Extension not detected.");
      return showCustomToast("customToast", "âŒ Ultra Extension not detected.");
    }

    if (!connectedAccount) {
      console.warn("âš ï¸ Wallet not connected.");
      return showCustomToast("customToast", "âš ï¸ Please connect your wallet.");
    }

    if (!tokenId || !priceInput || !promoterShare) {
      console.warn("âš ï¸ Missing fields for resale.");
      return showCustomToast("customToast", "âš ï¸ All fields are required for resell.");
    }

    const formattedPrice = `${parseFloat(priceInput).toFixed(8)} UOS`;
    console.log("ğŸ’° Resell price:", formattedPrice);

    const action = {
      account: "eosio.nft.ft",
      name: "resell",
      authorization: [{ actor: connectedAccount, permission: "active" }],
      data: {
        seller: connectedAccount,
        token_id: parseInt(tokenId),
        price: formattedPrice,
        promoter_basis_point: parseInt(promoterShare),
        memo: memo.substring(0, 255)
      }
    };

    console.log("ğŸš€ Resell action object:", action);

    try {
      const result = await ultra.signTransaction({ actions: [action] }, { blocksBehind: 3, expireSeconds: 30 });
      console.log("âœ… NFT listed for resale:", result);
      messageDiv.textContent = "âœ… NFT listed for resale successfully!";
    } catch (error) {
      console.error("âŒ Resell failed:", error);
      messageDiv.textContent = `âŒ Error: ${error.message || "Transaction failed."}`;
    }
  }

  // âœ… ØªØ­Ù‚Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  window.addEventListener('load', () => {
    console.log("ğŸŒ Page loaded.");
    if (localStorage.getItem('eagerlyConnection')) {
      console.log("ğŸ”„ Auto-connect enabled.");
      loginWallet();
    } else {
      console.log("ğŸ›‘ No previous wallet connection found.");
    }
  });
</script>


</body>
</html>
